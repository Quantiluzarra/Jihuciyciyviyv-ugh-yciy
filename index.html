<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>AI ARENA ONLINE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* ===== –ë–∞–∑–æ–≤—ã–π —Å–±—Ä–æ—Å –∏ —Å—Ç–∏–ª–∏ ===== */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: linear-gradient(120deg, #1c1c1c, #333);
      color: #fff;
      text-align: center;
      overflow-x: hidden;
      min-height: 100vh;
      padding: 20px;
    }
    h1 { margin: 10px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
    
    /* ===== –ê—Ä–µ–Ω–∞ ===== */
    .arenaContainer { margin-bottom: 20px; }
    #gameContainer {
      position: relative;
      border: 2px solid #555;
      border-radius: 8px;
      overflow: hidden;
      margin: 0 auto;
    }
    #gameCanvas { background: #222; display: block; }
    
    /* ===== –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ===== */
    .uiContainer {
      max-width: 900px;
      width: 100%;
      background: rgba(0,0,0,0.6);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      margin: 0 auto 20px auto;
    }
    .uiRow {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      margin: 8px 0;
    }
    .uiRow > div, .uiRow > input, .uiRow > button {
      margin: 6px 10px;
    }
    .label { font-weight: bold; color: #ffd700; }
    input[type="number"], input[type="text"] {
      width: 80px;
      text-align: center;
      padding: 4px;
      border: 1px solid #555;
      border-radius: 4px;
      background: #222;
      color: #fff;
    }
    button {
      padding: 8px 16px;
      font-weight: bold;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      transition: background 0.3s, transform 0.2s;
    }
    button:hover { transform: scale(1.03); filter: brightness(110%); }
    button:active { transform: scale(0.98); }
    .redButton { background-color: #e74c3c; color: #fff; }
    .blueButton { background-color: #3498db; color: #fff; }
    .startButton { background-color: #2ecc71; color: #fff; }
    
    /* ===== –õ–æ–≥ —Å–æ–±—ã—Ç–∏–π ===== */
    #logPanel {
      max-height: 150px;
      overflow-y: auto;
      background: rgba(0,0,0,0.3);
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 0.9em;
      text-align: left;
      margin: 0 auto;
      max-width: 900px;
    }
    #logPanel p { margin: 4px 0; line-height: 1.2em; }
  </style>
</head>
<body>
  <!-- –ê—Ä–µ–Ω–∞ -->
  <div class="arenaContainer">
    <h1>AI ARENA ONLINE</h1>
    <div id="gameContainer">
      <canvas id="gameCanvas" width="640" height="640"></canvas>
    </div>
  </div>
  
  <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
  <div class="uiContainer">
    <div class="uiRow">
      <div><span class="label">–ë–∞–ª–∞–Ω—Å:</span> <span id="balance">1000</span> C</div>
      <div><span class="label">–ö—Ä–∞—Å–Ω—ã–π (–∫–æ—ç—Ñ):</span> <span id="redOdds">1.50</span></div>
      <div><span class="label">–°–∏–Ω–∏–π (–∫–æ—ç—Ñ):</span> <span id="blueOdds">1.50</span></div>
    </div>
    <div class="uiRow">
      <div>
        <span class="label">–°—Ç–∞–≤–∫–∞ (C):</span>
        <input id="betAmount" type="number" value="100" min="1" />
      </div>
      <div>
        <span class="label">Win Multiplier:</span>
        <input id="winMultiplier" type="text" value="1.0" />
      </div>
    </div>
    <div class="uiRow">
      <button class="betButton redButton" onclick="betOn('red')">–ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –ö—Ä–∞—Å–Ω–æ–≥–æ</button>
      <button class="betButton blueButton" onclick="betOn('blue')">–ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –°–∏–Ω–µ–≥–æ</button>
    </div>
    <div class="uiRow">
      <button class="startButton" onclick="startGame()">–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É –∏ –Ω–∞—á–∞—Ç—å –±–æ–π</button>
    </div>
  </div>
  
  <!-- –õ–æ–≥ —Å–æ–±—ã—Ç–∏–π -->
  <div id="logPanel"></div>
  
  <script>
    // ---------------- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ----------------
    const GRID_WIDTH = 20;
    const GRID_HEIGHT = 20;
    const CELL_SIZE = 32;
    const moveDuration = 300; // –º—Å –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
    const aiThinkInterval = 400; // –º—Å –º–µ–∂–¥—É —Ä–µ—à–µ–Ω–∏—è–º–∏
    const MAX_HP = 100;
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const logPanel = document.getElementById('logPanel');
    
    // –°–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã –∏ —Å—Ç–∞–≤–æ–∫
    let gameRunning = false;
    let playerBalance = 1000;
    let betTeam = null; // 'red' –∏–ª–∏ 'blue'
    let betValue = 0;
    let redOddsValue = 1.5;
    let blueOddsValue = 1.5;
    let grid = [];
    
    // –û–±—ä–µ–∫—Ç—ã –ò–ò
    let redAI = null;
    let blueAI = null;
    
    // –¢–∞–π–º–µ—Ä—ã –¥–ª—è –ò–ò
    let redLastThink = 0;
    let blueLastThink = 0;
    
    // –≠—Ñ—Ñ–µ–∫—Ç—ã —ç–º–æ—Ü–∏–π
    let emojiList = [];
    
    // ---------------- –ü–ê–ú–Ø–¢–¨ AI (localStorage) ----------------
    let globalRedMemory = {};
    let globalBlueMemory = {};
    function loadAIMemory() {
      try {
        const redMemStr = localStorage.getItem('redAIMemory');
        if (redMemStr) globalRedMemory = JSON.parse(redMemStr);
        const blueMemStr = localStorage.getItem('blueAIMemory');
        if (blueMemStr) globalBlueMemory = JSON.parse(blueMemStr);
      } catch(e) { console.warn('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è localStorage:', e); }
    }
    function saveAIMemory() {
      try {
        localStorage.setItem('redAIMemory', JSON.stringify(globalRedMemory));
        localStorage.setItem('blueAIMemory', JSON.stringify(globalBlueMemory));
      } catch(e) { console.warn('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ localStorage:', e); }
    }
    loadAIMemory();
    
    // ---------------- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–ï–¢–ö–ò ----------------
    function initGrid() {
      grid = [];
      for (let y = 0; y < GRID_HEIGHT; y++) {
        const row = [];
        for (let x = 0; x < GRID_WIDTH; x++) {
          row.push(0);
        }
        grid.push(row);
      }
    }
    
    // ---------------- –°–û–ó–î–ê–ù–ò–ï –û–ë–™–ï–ö–¢–ê AI ----------------
    function createAI(type, x, y, baseX, baseY, memoryObj) {
      return {
        type,           // 1 –¥–ª—è –∫—Ä–∞—Å–Ω–æ–≥–æ, 2 –¥–ª—è —Å–∏–Ω–µ–≥–æ
        x, y,           // —Ç–µ–∫—É—â–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        oldX: x, oldY: y, // –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        targetX: x, targetY: y,
        moveStartTime: 0,
        hp: MAX_HP,
        baseX, baseY,
        memory: memoryObj,
        lastAction: null,
        color: type === 1 ? 'red' : 'blue',
        userControlled: false,  // —Ñ–ª–∞–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        controlEndTime: 0       // –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è
      };
    }
    
    // ---------------- UI –ò –°–¢–ê–í–ö–ò ----------------
    function updateUI() {
      document.getElementById('balance').innerText = playerBalance;
      document.getElementById('redOdds').innerText = redOddsValue;
      document.getElementById('blueOdds').innerText = blueOddsValue;
    }
    function betOn(team) {
      if (gameRunning) return alert("–ù–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å —Å—Ç–∞–≤–∫—É –≤–æ –≤—Ä–µ–º—è –±–æ—è!");
      const amount = parseInt(document.getElementById('betAmount').value);
      if (isNaN(amount) || amount <= 0) return alert("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞ —Å—Ç–∞–≤–∫–∏!");
      if (amount > playerBalance) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!");
      betTeam = team;
      betValue = amount;
      alert(`–°—Ç–∞–≤–∫–∞ ${betValue} C –Ω–∞ ${team === 'red' ? '–ö—Ä–∞—Å–Ω–æ–≥–æ' : '–°–∏–Ω–µ–≥–æ'}.`);
    }
    
    // ---------------- –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–ô –ö–û–ù–¢–†–û–õ–¨ AI ----------------
    function handleUserControl(clientX, clientY) {
      // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ canvas
      const rect = canvas.getBoundingClientRect();
      const x = Math.floor((clientX - rect.left) / CELL_SIZE);
      const y = Math.floor((clientY - rect.top) / CELL_SIZE);
      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –Ω–∞ –∫–ª–µ—Ç–∫—É, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è AI, –∏ —ç—Ç–æ AI, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–≥–æ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ —Å—Ç–∞–≤–∫–∞
      let targetAI = null;
      if (betTeam === 'red' && redAI && redAI.x === x && redAI.y === y) {
        targetAI = redAI;
      } else if (betTeam === 'blue' && blueAI && blueAI.x === x && blueAI.y === y) {
        targetAI = blueAI;
      }
      if (targetAI) {
        targetAI.userControlled = true;
        targetAI.controlEndTime = performance.now() + 5000; // 5 —Å–µ–∫—É–Ω–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è
        addLog(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å: ${targetAI.color} AI –ø–æ–¥—á–∏–Ω—è–µ—Ç—Å—è!`);
      } else {
        // –ï—Å–ª–∏ —É–∂–µ –≤ —Ä–µ–∂–∏–º–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –ø–æ —Ä–∞–∑–Ω–∏—Ü–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        let controlledAI = (betTeam === 'red' ? redAI : blueAI);
        if (controlledAI && controlledAI.userControlled) {
          const dx = x - controlledAI.x;
          const dy = y - controlledAI.y;
          // –ï—Å–ª–∏ –∫–ª–∏–∫ –Ω–µ –≤ —Ç–æ–π –∂–µ –∫–ª–µ—Ç–∫–µ, –∑–∞–¥–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —à–∞–≥ –¥–æ 1 –∫–ª–µ—Ç–∫–∏)
          if (Math.abs(dx) > 0 || Math.abs(dy) > 0) {
            const moveX = dx !== 0 ? (dx > 0 ? 1 : -1) : 0;
            const moveY = dy !== 0 ? (dy > 0 ? 1 : -1) : 0;
            startMove(controlledAI, controlledAI.x + moveX, controlledAI.y + moveY);
            addLog(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${controlledAI.color} AI –¥–≤–∏–∂–µ—Ç—Å—è ${moveX ? (moveX>0?"–≤–ø—Ä–∞–≤–æ":"–≤–ª–µ–≤–æ") : ""} ${moveY ? (moveY>0?"–≤–Ω–∏–∑":"–≤–≤–µ—Ä—Ö"):""}`);
          }
        }
      }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è click –∏ touchstart
    canvas.addEventListener('click', (e) => {
      handleUserControl(e.clientX, e.clientY);
    });
    canvas.addEventListener('touchstart', (e) => {
      const touch = e.touches[0];
      handleUserControl(touch.clientX, touch.clientY);
    });
    
    // ---------------- –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ –ò–ì–†–´ ----------------
    function startGame() {
      if (gameRunning) return;
      if (!betTeam) return alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ, –Ω–∞ –∫–æ–≥–æ —Å—Ç–∞–≤–∏—Ç–µ!');
      if (betValue <= 0) return alert('–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0!');
      if (betValue > playerBalance) return alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!');
      
      // –°–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç–∞–≤–∫—É
      playerBalance -= betValue;
      updateUI();
      
      // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ (–∞–≤—Ç–æ–º–∞—Ç, –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è Win Multiplier –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
      redOddsValue  = (1.2 + Math.random() * 1.0).toFixed(2);
      blueOddsValue = (1.2 + Math.random() * 1.0).toFixed(2);
      document.getElementById('redOdds').innerText = redOddsValue;
      document.getElementById('blueOdds').innerText = blueOddsValue;
      
      initGrid();
      
      // –°–æ–∑–¥–∞–µ–º AI: –ö—Ä–∞—Å–Ω—ã–π –≤ –ª–µ–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º, –°–∏–Ω–∏–π –≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º
      redAI = createAI(1, 0, 0, 0, 0, globalRedMemory);
      blueAI = createAI(2, GRID_WIDTH - 1, GRID_HEIGHT - 1, GRID_WIDTH - 1, GRID_HEIGHT - 1, globalBlueMemory);
      grid[redAI.y][redAI.x] = 1; // –±–∞–∑–∞ –∫—Ä–∞—Å–Ω–æ–≥–æ
      grid[blueAI.y][blueAI.x] = 2; // –±–∞–∑–∞ —Å–∏–Ω–µ–≥–æ
      
      emojiList = [];
      clearLog();
      redLastThink = 0; blueLastThink = 0;
      
      gameRunning = true;
      window.lastFrameTime = performance.now();
      requestAnimationFrame(gameLoop);
      addLog("–ù–æ–≤–∞—è –±–∏—Ç–≤–∞ –Ω–∞—á–∞–ª–∞—Å—å!");
    }
    
    function gameLoop(timestamp) {
      if (!gameRunning) return;
      const dt = timestamp - (window.lastFrameTime || timestamp);
      window.lastFrameTime = timestamp;
      
      // –ï—Å–ª–∏ AI –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –±–∞–∑–µ, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º HP (–Ω–∞–ø—Ä–∏–º–µ—Ä, 5 HP –≤ —Å–µ–∫—É–Ω–¥—É)
      [redAI, blueAI].forEach(ai => {
        if (ai && ai.x === ai.baseX && ai.y === ai.baseY && ai.hp < MAX_HP) {
          ai.hp = Math.min(MAX_HP, ai.hp + (dt / 1000) * 5);
        }
      });
      
      // –ï—Å–ª–∏ AI –≤ —Ä–µ–∂–∏–º–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚Äì –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è
      [redAI, blueAI].forEach(ai => {
        if (ai && ai.userControlled && performance.now() > ai.controlEndTime) {
          ai.userControlled = false;
          addLog(`${ai.color} AI –≤–æ–∑–æ–±–Ω–æ–≤–∏–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.`);
        }
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π
      updateAIPosition(redAI);
      updateAIPosition(blueAI);
      
      // –ï—Å–ª–∏ AI –Ω–µ –ø–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º, –∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ
      if (redAI && !redAI.userControlled) {
        redLastThink += dt;
        if (redLastThink >= aiThinkInterval) { redLastThink = 0; aiDecideMove(redAI, blueAI); }
      }
      if (blueAI && !blueAI.userControlled) {
        blueLastThink += dt;
        if (blueLastThink >= aiThinkInterval) { blueLastThink = 0; aiDecideMove(blueAI, redAI); }
      }
      
      checkWinCondition();
      render();
      
      if (gameRunning) requestAnimationFrame(gameLoop);
    }
    
    // ---------------- –ü–õ–ê–í–ù–ê–Ø –ê–ù–ò–ú–ê–¶–ò–Ø –ü–ï–†–ï–ú–ï–©–ï–ù–ò–Ø ----------------
    function startMove(ai, nx, ny) {
      ai.oldX = ai.x;
      ai.oldY = ai.y;
      ai.targetX = nx;
      ai.targetY = ny;
      ai.moveStartTime = performance.now();
      // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–≥–∏—á–µ—Å–∫–∏ —Å—Ä–∞–∑—É:
      ai.x = nx;
      ai.y = ny;
    }
    function updateAIPosition(ai) {
      if (!ai) return;
      const now = performance.now();
      const elapsed = now - ai.moveStartTime;
      let t = Math.min(elapsed / moveDuration, 1);
      ai.renderX = ai.oldX + (ai.targetX - ai.oldX) * t;
      ai.renderY = ai.oldY + (ai.targetY - ai.oldY) * t;
    }
    
    // ---------------- –ü–û–î–°–ß–ï–¢ –ó–ê–•–í–ê–ß–ï–ù–ù–´–• –ö–õ–ï–¢–û–ö ----------------
    function countTerritory(type) {
      let count = 0;
      for (let y = 0; y < GRID_HEIGHT; y++) {
        for (let x = 0; x < GRID_WIDTH; x++) {
          if (grid[y][x] === type) count++;
        }
      }
      return count;
    }
    
    // ---------------- –õ–û–ì–ò–ö–ê AI ----------------
    function aiDecideMove(ai, opponent) {
      if (ai.hp <= 0) return;
      // –ï—Å–ª–∏ –∞–Ω–∏–º–∞—Ü–∏—è –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –Ω–µ —Ä–µ—à–∞–µ–º –Ω–æ–≤–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
      if (performance.now() - ai.moveStartTime < moveDuration) return;
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º stateKey, —É—á–∏—Ç—ã–≤–∞—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ –∏, –µ—Å–ª–∏ HP –Ω–∏–∑–∫–æ–µ, —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –±–∞–∑—ã
      const dx = opponent.x - ai.x;
      const dy = opponent.y - ai.y;
      const hpSelf = ai.hp;
      const hpOpp = opponent.hp;
      const territorySelf = countTerritory(ai.type);
      const territoryOpp = countTerritory(opponent.type);
      let stateKey = dx + ',' + dy + ',' + hpSelf + ',' + hpOpp + ',' + territorySelf + ',' + territoryOpp;
      if (hpSelf < 30) {
        const baseDx = ai.baseX - ai.x;
        const baseDy = ai.baseY - ai.y;
        stateKey += ',base:' + baseDx + ',' + baseDy;
      }
      if (!ai.memory[stateKey]) {
        ai.memory[stateKey] = { up: 0, down: 0, left: 0, right: 0 };
      }
      const mem = ai.memory[stateKey];
      
      // –ï—Å–ª–∏ –∑–¥–æ—Ä–æ–≤—å–µ –æ—á–µ–Ω—å –Ω–∏–∑–∫–æ–µ, AI –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –∑–∞—Å—Ç—Ä–µ–≤–∞—Ç—å –Ω–∞ –±–∞–∑–µ
      // –ü–æ—ç—Ç–æ–º—É, –µ—Å–ª–∏ HP < 30, –≤—ã–±–∏—Ä–∞–µ–º —Ö–æ–¥, –º–∏–Ω–∏–º–∏–∑–∏—Ä—É—é—â–∏–π —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –±–∞–∑—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ AI –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —É–∂–µ –Ω–∞ –±–∞–∑–µ
      let moves = [];
      function tryMove(name, px, py) {
        const nx = ai.x + px;
        const ny = ai.y + py;
        if (nx >= 0 && nx < GRID_WIDTH && ny >= 0 && ny < GRID_HEIGHT) {
          const weight = mem[name] + Math.random();
          moves.push({ name, px, py, weight });
        }
      }
      tryMove('up', 0, -1);
      tryMove('down', 0, 1);
      tryMove('left', -1, 0);
      tryMove('right', 1, 0);
      
      let bestMove;
      if (hpSelf < 30 && !(ai.x === ai.baseX && ai.y === ai.baseY)) {
        // –ï—Å–ª–∏ –∑–¥–æ—Ä–æ–≤—å–µ –Ω–∏–∑–∫–æ–µ –∏ AI –Ω–µ –Ω–∞ –±–∞–∑–µ, –≤—ã–±–∏—Ä–∞–µ–º —Ö–æ–¥, –º–∏–Ω–∏–º–∏–∑–∏—Ä—É—é—â–∏–π —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –±–∞–∑—ã
        moves.sort((a, b) => {
          const distA = Math.abs((ai.x + a.px) - ai.baseX) + Math.abs((ai.y + a.py) - ai.baseY);
          const distB = Math.abs((ai.x + b.px) - ai.baseX) + Math.abs((ai.y + b.py) - ai.baseY);
          return distA - distB;
        });
        bestMove = moves[0];
      } else {
        moves.sort((a, b) => b.weight - a.weight);
        bestMove = moves[0];
      }
      ai.lastAction = { stateKey, direction: bestMove.name };
      startMove(ai, ai.x + bestMove.px, ai.y + bestMove.py);
      
      // –ü–æ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ –∏ –∑–∞—Ö–≤–∞—Ç –∫–ª–µ—Ç–∫–∏
      setTimeout(() => {
        if (!gameRunning || ai.hp <= 0) return;
        if (ai.x === opponent.x && ai.y === opponent.y && opponent.hp > 0) {
          const dmgAI = Math.floor(Math.random() * 20);
          const dmgOpp = Math.floor(Math.random() * 20);
          ai.hp = Math.max(0, ai.hp - dmgAI);
          opponent.hp = Math.max(0, opponent.hp - dmgOpp);
          showEmoji(ai, 'üí•');
          showEmoji(opponent, 'üí•');
          const reward = (dmgOpp - dmgAI) * 0.1;
          mem[bestMove.name] += reward;
          addLog(`–°—Ö–≤–∞—Ç–∫–∞! ${ai.color} –ø–æ–ª—É—á–∏–ª ${dmgAI}, –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫ ${dmgOpp}.`);
        }
        // –ó–∞—Ö–≤–∞—Ç –∫–ª–µ—Ç–∫–∏
        const oldControl = grid[ai.y][ai.x];
        if (oldControl !== ai.type) {
          if (oldControl !== 0 && oldControl !== ai.type) {
            showEmoji(ai, 'üòé');
            showEmoji(opponent, 'üò°');
            mem[bestMove.name] += 0.5;
            addLog(`${ai.color} –∑–∞—Ö–≤–∞—Ç–∏–ª –∫–ª–µ—Ç–∫—É —É —Å–æ–ø–µ—Ä–Ω–∏–∫–∞!`);
          }
          grid[ai.y][ai.x] = ai.type;
        }
      }, moveDuration);
    }
    
    // ---------------- –ü–†–û–í–ï–†–ö–ê –ü–û–ë–ï–î–´ ----------------
    function checkWinCondition() {
      if (grid[redAI.baseY][redAI.baseX] === 2 || redAI.hp <= 0) {
        endGame('blue');
      } else if (grid[blueAI.baseY][blueAI.baseX] === 1 || blueAI.hp <= 0) {
        endGame('red');
      }
    }
    
    // ---------------- –ó–ê–í–ï–†–®–ï–ù–ò–ï –ò–ì–†–´ ----------------
    function endGame(winner) {
      if (!gameRunning) return;
      gameRunning = false;
      saveAIMemory();
      // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –≤—ã–∏–≥—Ä—ã—à–∞ —Å —É—á–µ—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –º–Ω–æ–∂–∏—Ç–µ–ª—è
      let customMultiplier = parseFloat(document.getElementById('winMultiplier').value) || 1.0;
      if (winner === betTeam) {
        const odds = (winner === 'red') ? parseFloat(redOddsValue) : parseFloat(blueOddsValue);
        const winAmount = Math.floor(betValue * odds * customMultiplier);
        playerBalance += winAmount;
        alert(`–ü–æ–±–µ–¥–∏–ª ${winner === 'red' ? '–ö—Ä–∞—Å–Ω—ã–π' : '–°–∏–Ω–∏–π'}! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ ${winAmount} C!`);
      } else {
        alert(`–ü–æ–±–µ–¥–∏–ª ${winner === 'red' ? '–ö—Ä–∞—Å–Ω—ã–π' : '–°–∏–Ω–∏–π'}! –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏ —Å—Ç–∞–≤–∫—É.`);
      }
      betTeam = null;
      betValue = 0;
      updateUI();
    }
    
    // ---------------- –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –°–û–ë–´–¢–ò–ô ----------------
    function addLog(msg) {
      const p = document.createElement('p');
      p.textContent = msg;
      logPanel.appendChild(p);
      logPanel.scrollTop = logPanel.scrollHeight;
    }
    function clearLog() { logPanel.innerHTML = ""; }
    
    // ---------------- –≠–ú–û–¶–ò–ò ----------------
    function showEmoji(ai, symbol) {
      emojiList.push({
        x: ai.x,
        y: ai.y,
        symbol: symbol,
        time: Date.now(),
        duration: 1500
      });
    }
    
    // ---------------- –†–ï–ù–î–ï–† ----------------
    function render() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É
      for (let y = 0; y < GRID_HEIGHT; y++) {
        for (let x = 0; x < GRID_WIDTH; x++) {
          let color = '#444';
          if (grid[y][x] === 1) color = 'red';
          else if (grid[y][x] === 2) color = 'blue';
          ctx.fillStyle = color;
          ctx.fillRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
        }
      }
      // –†–∏—Å—É–µ–º AI
      drawAI(redAI);
      drawAI(blueAI);
      // –†–∏—Å—É–µ–º HP-–±–∞—Ä—ã
      drawHPBar(redAI);
      drawHPBar(blueAI);
      // –†–∏—Å—É–µ–º —ç–º–æ—Ü–∏–∏
      drawEmojis();
    }
    function drawAI(ai) {
      if (!ai || ai.hp <= 0) return;
      const px = (ai.renderX ?? ai.x) * CELL_SIZE;
      const py = (ai.renderY ?? ai.y) * CELL_SIZE;
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 2;
      ctx.strokeRect(px + 2, py + 2, CELL_SIZE - 4, CELL_SIZE - 4);
    }
    function drawHPBar(ai) {
      if (!ai || ai.hp <= 0) return;
      const px = (ai.renderX ?? ai.x) * CELL_SIZE;
      const py = (ai.renderY ?? ai.y) * CELL_SIZE;
      const barWidth = CELL_SIZE - 4;
      const barHeight = 5;
      const barX = px + 2;
      const barY = py - 8;
      ctx.fillStyle = '#000';
      ctx.fillRect(barX, barY, barWidth, barHeight);
      const hpPercent = ai.hp / MAX_HP;
      ctx.fillStyle = ai.color === 'red' ? '#ff5555' : '#55aaff';
      ctx.fillRect(barX, barY, barWidth * hpPercent, barHeight);
    }
    function drawEmojis() {
      const now = Date.now();
      emojiList = emojiList.filter(e => now - e.time < e.duration);
      ctx.font = '20px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      for (const emo of emojiList) {
        const t = (now - emo.time) / 1500;
        ctx.globalAlpha = 1 - t;
        const px = emo.x * CELL_SIZE + CELL_SIZE / 2;
        const py = emo.y * CELL_SIZE - 20 - 20 * t;
        ctx.fillText(emo.symbol, px, py);
      }
      ctx.globalAlpha = 1;
    }
    
    // ---------------- –ò–ù–ò–¶–ò–ê–õ–¨–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ----------------
    updateUI();
    redOddsValue  = (1.2 + Math.random() * 1.0).toFixed(2);
    blueOddsValue = (1.2 + Math.random() * 1.0).toFixed(2);
    document.getElementById('redOdds').innerText = redOddsValue;
    document.getElementById('blueOdds').innerText = blueOddsValue;
  </script>
</body>
</html>
